name: "[1+2] Build Complete Toolchain + Kernel RootFS"

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-complete:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup ARM64 environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu \
          build-essential \
          libncurses-dev \
          bc \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          wget \
          curl \
          xz-utils \
          git \
          make \
          qemu-system-aarch64

    - name: Download sources
      run: |
        chmod +x scripts/download-sources.sh
        ./scripts/download-sources.sh

    # ========== PHASE 1: TOOLCHAIN ==========
    - name: Build Binutils
      run: |
        tar xf sources/binutils-2.42.tar.xz
        cd binutils-2.42
        mkdir build && cd build
        ../configure --target=aarch64-linux-gnu --prefix=/usr --disable-werror
        make -j$(nproc)
        make DESTDIR=$PWD/install install
        cd ../..

    - name: Build Linux Kernel Headers
      run: |
        tar xf sources/linux-6.6.9.tar.xz
        cd linux-6.6.9
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- headers_install
        cd ..

    # ========== PHASE 2: KERNEL + ROOTFS ==========
    - name: Build Linux Kernel (FAST Optimized)
      run: |
        cd linux-6.6.9
        
        # Pakai defconfig untuk build cepat
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        # OPTIMASI MAXIMAL untuk build cepat
        ./scripts/config --disable DEBUG_INFO
        ./scripts/config --disable DEBUG_KERNEL
        ./scripts/config --disable DEBUG_FS
        ./scripts/config --disable PROFILING
        ./scripts/config --disable KPROBES
        ./scripts/config --disable KGDB
        ./scripts/config --disable SCHED_DEBUG
        ./scripts/config --disable FTRACE
        ./scripts/config --disable DYNAMIC_DEBUG
        ./scripts/config --disable MODULES
        ./scripts/config --disable IKCONFIG
        ./scripts/config --disable AUDIT
        ./scripts/config --disable SECURITY
        ./scripts/config --disable NETWORK_FILESYSTEMS
        ./scripts/config --disable WIRELESS
        ./scripts/config --disable BLUETOOTH
        ./scripts/config --disable DRM
        ./scripts/config --disable SOUND
        ./scripts/config --disable HID
        ./scripts/config --disable USB
        ./scripts/config --disable PCI
        
        # Enable yang penting saja
        ./scripts/config --enable DEVTMPFS
        ./scripts/config --enable DEVTMPFS_MOUNT
        ./scripts/config --enable TTY
        ./scripts/config --enable SERIAL_AMBA_PL011
        ./scripts/config --enable SERIAL_AMBA_PL011_CONSOLE
        
        # Build dengan optimasi speed
        echo "ðŸš€ Building kernel with MAX optimization..."
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        time make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
        cd ..

    - name: Build musl libc
      run: |
        tar xf sources/musl-1.2.4.tar.gz
        cd musl-1.2.4
        ./configure --prefix=/usr --target=aarch64-linux-gnu
        make -j$(nproc)
        make DESTDIR=$PWD/install install
        cd ..

    - name: Build BusyBox (Fixed - No Interactive)
      run: |
        tar xf sources/busybox-1.36.1.tar.bz2
        cd busybox-1.36.1
        
        # Pakai defconfig
        make CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        # FIX: Gunakan sed untuk modifikasi config
        sed -i 's/CONFIG_STATIC=.*/CONFIG_STATIC=y/' .config
        sed -i 's/CONFIG_FEATURE_IPV6=.*/# CONFIG_FEATURE_IPV6 is not set/' .config
        sed -i 's/CONFIG_TC=.*/# CONFIG_TC is not set/' .config
        sed -i 's/CONFIG_IP=.*/# CONFIG_IP is not set/' .config
        sed -i 's/CONFIG_NETWORKING=.*/# CONFIG_NETWORKING is not set/' .config
        
        # Non-interactive build
        echo "ðŸ”¨ Building BusyBox static..."
        make CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        time make CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
        cd ..

    - name: Create minimal rootfs
      run: |
        mkdir -p rootfs/{bin,dev,etc,proc,sys,usr/bin,usr/lib,tmp,home,wildan}
        cp busybox-1.36.1/busybox rootfs/bin/
        cp -r musl-1.2.4/install/usr/lib/* rootfs/usr/lib/
        
        # Pastikan busybox executable
        chmod +x rootfs/bin/busybox
        
        # Create busybox symlinks
        cd rootfs/bin
        for app in $(./busybox --list); do
          ln -s busybox $app 2>/dev/null || true
        done
        cd ../..

    - name: Create init script
      run: |
        echo '#!/bin/sh' > rootfs/init
        echo 'mount -t proc none /proc' >> rootfs/init
        echo 'mount -t sysfs none /sys' >> rootfs/init
        echo 'mount -t devtmpfs none /dev' >> rootfs/init
        echo 'echo ""' >> rootfs/init
        echo 'echo "ðŸ§ Welcome to Zen Unix - Wildan Distro!"' >> rootfs/init
        echo 'echo "ðŸ“± ARM64 Linux by Wildan Hermawan"' >> rootfs/init
        echo 'echo "ðŸš€ Kernel: $(uname -r)"' >> rootfs/init
        echo 'echo ""' >> rootfs/init
        echo 'exec /bin/sh' >> rootfs/init
        chmod +x rootfs/init

    - name: Create essential device nodes
      run: |
        sudo mknod rootfs/dev/console c 5 1
        sudo mknod rootfs/dev/null c 1 3

    - name: Create bootable image
      run: |
        dd if=/dev/zero of=zen-unix.img bs=1M count=64
        mkfs.ext4 -F zen-unix.img
        mkdir -p mnt
        sudo mount -o loop zen-unix.img mnt
        sudo cp -r rootfs/* mnt/
        sudo umount mnt

    - name: Upload final image
      uses: actions/upload-artifact@v4
      with:
        name: zen-unix-complete
        path: |
          zen-unix.img
          linux-6.6.9/arch/arm64/boot/Image
        retention-days: 7

    - name: Show build success
      run: |
        echo "âœ… Build completed successfully!"
        echo "ðŸ“¦ Final artifacts: zen-unix.img + Kernel Image"
        ls -lh zen-unix.img
        ls -lh linux-6.6.9/arch/arm64/boot/Image
