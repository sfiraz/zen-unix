name: "Zen Unix Complete Build"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Zen Unix Version'
        required: true
        default: '1.0.0'
  push:
    branches: [main]

env:
  ZEN_VERSION: '1.0.0'
  BUILD_ARCH: 'aarch64'
  KERNEL_VERSION: '6.6.9'
  MUSL_VERSION: '1.2.4'
  BUSYBOX_VERSION: '1.36.1'
  BINUTILS_VERSION: '2.42'

jobs:
  build-complete-system:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu \
          build-essential \
          libncurses-dev \
          bc \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          wget \
          curl \
          xz-utils \
          git \
          make \
          cmake \
          qemu-system-aarch64 \
          qemu-user-static

    - name: Create directory structure
      run: |
        mkdir -p sources build rootfs output
        mkdir -p rootfs/{bin,dev,etc,proc,sys,usr/{bin,lib,local,share,include},var/{cache,log,lib},tmp,home,root,boot,mnt,opt,run}
        mkdir -p rootfs/etc/apk

    - name: Download source packages
      run: |
        cd sources
        echo "Downloading source packages"
        
        wget --timeout=60 --tries=3 https://mirror.koddos.net/gnu/binutils/binutils-2.42.tar.xz || \
        wget --timeout=60 --tries=3 https://ftp.gnu.org/gnu/binutils/binutils-2.42.tar.xz
        
        wget --timeout=60 --tries=3 https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.9.tar.xz
        
        wget --timeout=60 --tries=3 https://musl.libc.org/releases/musl-1.2.4.tar.gz
        
        wget --timeout=60 --tries=3 https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        
        cd ..

    - name: Build Binutils
      run: |
        echo "Building Binutils"
        tar xf sources/binutils-2.42.tar.xz
        cd binutils-2.42
        mkdir build && cd build
        ../configure --target=aarch64-linux-gnu --prefix=/usr --disable-werror
        make -j$(nproc)
        make DESTDIR=$PWD/install install
        cd ../..

    - name: Build Linux Kernel Headers
      run: |
        echo "Building Kernel Headers"
        tar xf sources/linux-6.6.9.tar.xz
        cd linux-6.6.9
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- headers_install
        cd ..

    - name: Build Linux Kernel
      run: |
        echo "Building Linux Kernel"
        cd linux-6.6.9
        
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        ./scripts/config --disable DEBUG_INFO
        ./scripts/config --disable DEBUG_KERNEL
        ./scripts/config --disable DEBUG_FS
        ./scripts/config --disable PROFILING
        ./scripts/config --disable KPROBES
        ./scripts/config --disable KGDB
        ./scripts/config --disable SCHED_DEBUG
        ./scripts/config --disable FTRACE
        ./scripts/config --disable DYNAMIC_DEBUG
        ./scripts/config --disable MODULES
        
        ./scripts/config --enable DEVTMPFS
        ./scripts/config --enable DEVTMPFS_MOUNT
        ./scripts/config --enable TTY
        ./scripts/config --enable SERIAL_AMBA_PL011
        ./scripts/config --enable SERIAL_AMBA_PL011_CONSOLE
        
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        time make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
        cd ..

    - name: Build musl libc
      run: |
        echo "Building musl libc"
        tar xf sources/musl-1.2.4.tar.gz
        cd musl-1.2.4
        ./configure --prefix=/usr --target=aarch64-linux-gnu
        make -j$(nproc)
        make DESTDIR=$PWD/install install
        cp -r install/usr/* ../rootfs/usr/
        cd ..

    - name: Build BusyBox Fixed
      run: |
        echo "Building BusyBox with fixes"
        tar xf sources/busybox-1.36.1.tar.bz2
        cd busybox-1.36.1
        
        make CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        sed -i 's/CONFIG_STATIC=.*/CONFIG_STATIC=y/' .config
        sed -i 's/CONFIG_FEATURE_IPV6=.*/# CONFIG_FEATURE_IPV6 is not set/' .config
        
        sed -i 's/CONFIG_TC=.*/# CONFIG_TC is not set/' .config
        sed -i 's/CONFIG_WATCHDOG=.*/# CONFIG_WATCHDOG is not set/' .config
        sed -i 's/CONFIG_SLATTACH=.*/# CONFIG_SLATTACH is not set/' .config
        sed -i 's/CONFIG_UDHCPD=.*/# CONFIG_UDHCPD is not set/' .config
        sed -i 's/CONFIG_UDHCPC=.*/# CONFIG_UDHCPC is not set/' .config
        sed -i 's/CONFIG_FEATURE_UDHCPD_WRITE_LEASES_EARLY=.*/# CONFIG_FEATURE_UDHCPD_WRITE_LEASES_EARLY is not set/' .config
        sed -i 's/CONFIG_FEATURE_UDHCPD_BASE_IP_ON_MAC=.*/# CONFIG_FEATURE_UDHCPD_BASE_IP_ON_MAC is not set/' .config
        
        yes "n" | make CROSS_COMPILE=aarch64-linux-gnu- oldconfig
        time make CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
        
        cp busybox ../rootfs/bin/
        chmod +x ../rootfs/bin/busybox
        cd ..

    - name: Setup BusyBox symlinks
      run: |
        echo "Creating BusyBox symlinks"
        cd rootfs/bin
        for app in $(./busybox --list); do
          if [ ! -e "$app" ] && [ "$app" != "busybox" ]; then
            ln -s busybox "$app"
          fi
        done
        cd ../..

    - name: Setup Alpine APK package manager with fixed URLs
      run: |
        echo "Setting up Alpine APK package manager with fixed URLs"
        
        # Download APK tools static dengan URL yang valid
        wget -O apk-tools-static.tar.gz http://dl-cdn.alpinelinux.org/alpine/latest-stable/main/aarch64/apk-tools-static-2.14.0-r0.apk || \
        wget -O apk-tools-static.tar.gz http://dl-cdn.alpinelinux.org/alpine/v3.18/main/aarch64/apk-tools-static-2.12.11-r1.apk
        
        tar -xzf apk-tools-static.tar.gz
        cp sbin/apk.static rootfs/sbin/ || cp usr/sbin/apk.static rootfs/sbin/
        chmod +x rootfs/sbin/apk.static
        
        mkdir -p rootfs/etc/apk
        echo "http://dl-cdn.alpinelinux.org/alpine/latest-stable/main" > rootfs/etc/apk/repositories
        echo "http://dl-cdn.alpinelinux.org/alpine/latest-stable/community" >> rootfs/etc/apk/repositories
        
        mkdir -p rootfs/etc/apk/keys
        wget -O alpine-keys.tar.gz http://dl-cdn.alpinelinux.org/alpine/latest-stable/main/aarch64/alpine-keys-2.4-r1.apk || \
        wget -O alpine-keys.tar.gz http://dl-cdn.alpinelinux.org/alpine/v3.18/main/aarch64/alpine-keys-2.4-r1.apk
        
        tar -xzf alpine-keys.tar.gz
        cp -r etc/apk/keys/* rootfs/etc/apk/keys/ 2>/dev/null || true

    - name: Install Alpine packages with fallback
      run: |
        echo "Installing Alpine packages with fallback method"
        
        cp /usr/bin/qemu-aarch64-static rootfs/usr/bin/
        chmod +x rootfs/usr/bin/qemu-aarch64-static
        
        echo "nameserver 8.8.8.8" > rootfs/etc/resolv.conf
        echo "nameserver 1.1.1.1" >> rootfs/etc/resolv.conf
        echo "zen-unix" > rootfs/etc/hostname
        
        echo "/dev/root / ext4 defaults 0 1" > rootfs/etc/fstab
        echo "proc /proc proc defaults 0 0" >> rootfs/etc/fstab
        echo "tmpfs /tmp tmpfs defaults 0 0" >> rootfs/etc/fstab
        echo "sysfs /sys sysfs defaults 0 0" >> rootfs/etc/fstab
        echo "devtmpfs /dev devtmpfs defaults 0 0" >> rootfs/etc/fstab

        # Try to update and install alpine-base
        sudo chroot rootfs /sbin/apk.static update || echo "APK update failed, continuing..."
        sudo chroot rootfs /sbin/apk.static add --no-cache alpine-base || echo "Alpine base installation failed"
        
        # Install essential packages individually dengan retry
        for package in bash curl wget nano htop neofetch git openssh tmux tree; do
          echo "Installing $package"
          sudo chroot rootfs /sbin/apk add --no-cache $package || echo "Failed to install $package"
        done
        
        # Install development tools
        for package in go build-base cmake pkgconfig; do
          echo "Installing $package"
          sudo chroot rootfs /sbin/apk add --no-cache $package || echo "Failed to install $package"
        done
        
        # Install system tools
        for package in util-linux e2fsprogs kbd kmod iproute2 iputils dhcpcd openssh-server sudo; do
          echo "Installing $package"
          sudo chroot rootfs /sbin/apk add --no-cache $package || echo "Failed to install $package"
        done
        
        rm rootfs/usr/bin/qemu-aarch64-static

    - name: Install additional tools manually if APK failed
      run: |
        echo "Installing additional tools manually"
        
        # Download static binaries untuk tools yang penting
        mkdir -p rootfs/usr/local/bin
        
        # Download static bash sebagai fallback
        wget -O rootfs/bin/bash-static https://github.com/robxu9/bash-static/releases/download/5.1.008-1/bash-linux-aarch64
        chmod +x rootfs/bin/bash-static
        
        # Download static curl
        wget -O rootfs/usr/local/bin/curl https://github.com/moparisthebest/static-curl/releases/download/v7.88.1/curl-amd64
        chmod +x rootfs/usr/local/bin/curl
        
        # Copy system binaries sebagai fallback
        cp /usr/bin/qemu-aarch64-static rootfs/usr/bin/
        chmod +x rootfs/usr/bin/qemu-aarch64-static

    - name: Create init script
      run: |
        echo "Creating init script"
        
        echo '#!/bin/bash' > rootfs/init
        echo '' >> rootfs/init
        echo 'export PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin' >> rootfs/init
        echo '' >> rootfs/init
        echo 'mount -t proc none /proc' >> rootfs/init
        echo 'mount -t sysfs none /sys' >> rootfs/init
        echo 'mount -t devtmpfs none /dev' >> rootfs/init
        echo 'mount -t tmpfs none /tmp' >> rootfs/init
        echo '' >> rootfs/init
        echo 'mknod /dev/console c 5 1 2>/dev/null || true' >> rootfs/init
        echo 'mknod /dev/null c 1 3 2>/dev/null || true' >> rootfs/init
        echo 'mknod /dev/zero c 1 5 2>/dev/null || true' >> rootfs/init
        echo 'mknod /dev/random c 1 8 2>/dev/null || true' >> rootfs/init
        echo '' >> rootfs/init
        echo 'mkdir -p /var/run/dhcpcd' >> rootfs/init
        echo 'ip link set lo up' >> rootfs/init
        echo '' >> rootfs/init
        echo 'if [ -f /usr/sbin/sshd ]; then' >> rootfs/init
        echo '    /usr/sbin/sshd &' >> rootfs/init
        echo '    echo "SSH server started"' >> rootfs/init
        echo 'fi' >> rootfs/init
        echo '' >> rootfs/init
        echo 'clear' >> rootfs/init
        echo 'echo "================================================"' >> rootfs/init
        echo 'echo "    ___    _   _   ___   _   _   ___"' >> rootfs/init
        echo 'echo "   |__ \\  | \\ | | |__ \\ | \\ | | / _ \\"' >> rootfs/init
        echo 'echo "      ) | |  \\| |    ) ||  \\| || | | |"' >> rootfs/init
        echo 'echo "     / /  | . \` |   / / | . \` || | | |"' >> rootfs/init
        echo 'echo "    / /_  | |\\  |  / /_ | |\\  || |_| |"' >> rootfs/init
        echo 'echo "   |____| |_| \\_| |____||_| \\_| \\___/"' >> rootfs/init
        echo 'echo "================================================"' >> rootfs/init
        echo 'echo "ARM64 Linux Distro by Wildan Hermawan"' >> rootfs/init
        echo 'echo "GitHub: https://github.com/sfiraz"' >> rootfs/init
        echo 'echo "Version: 1.0.0"' >> rootfs/init
        echo 'echo "Kernel: $(uname -r)"' >> rootfs/init
        echo 'echo "================================================"' >> rootfs/init
        echo 'echo ""' >> rootfs/init
        echo '' >> rootfs/init
        echo 'export PS1="[\\u@zen-unix:\\w]# "' >> rootfs/init
        echo 'exec /bin/bash' >> rootfs/init
        
        chmod +x rootfs/init

    - name: Create user environment
      run: |
        echo "Creating user environment"
        
        echo '# Zen Unix Custom Bash Configuration' > rootfs/root/.bashrc
        echo '' >> rootfs/root/.bashrc
        echo 'export PS1="[\\u@zen-unix:\\w]# "' >> rootfs/root/.bashrc
        echo 'export TERM=xterm-256color' >> rootfs/root/.bashrc
        echo '' >> rootfs/root/.bashrc
        echo 'alias ls="ls --color=auto"' >> rootfs/root/.bashrc
        echo 'alias ll="ls -la"' >> rootfs/root/.bashrc
        echo 'alias la="ls -A"' >> rootfs/root/.bashrc
        echo 'alias grep="grep --color=auto"' >> rootfs/root/.bashrc
        echo 'alias ..="cd .."' >> rootfs/root/.bashrc
        echo 'alias ...="cd ../.."' >> rootfs/root/.bashrc
        echo '' >> rootfs/root/.bashrc
        echo 'zenfetch() {' >> rootfs/root/.bashrc
        echo '    clear' >> rootfs/root/.bashrc
        echo '    echo "================================================"' >> rootfs/root/.bashrc
        echo '    echo "    ___    _   _   ___   _   _   ___"' >> rootfs/root/.bashrc
        echo '    echo "   |__ \\  | \\ | | |__ \\ | \\ | | / _ \\"' >> rootfs/root/.bashrc
        echo '    echo "      ) | |  \\| |    ) ||  \\| || | | |"' >> rootfs/root/.bashrc
        echo '    echo "     / /  | . \` |   / / | . \` || | | |"' >> rootfs/root/.bashrc
        echo '    echo "    / /_  | |\\  |  / /_ | |\\  || |_| |"' >> rootfs/root/.bashrc
        echo '    echo "   |____| |_| \\_| |____||_| \\_| \\___/"' >> rootfs/root/.bashrc
        echo '    echo "================================================"' >> rootfs/root/.bashrc
        echo '    echo "ARM64 Linux by Wildan Hermawan"' >> rootfs/root/.bashrc
        echo '    echo "GitHub: https://github.com/sfiraz"' >> rootfs/root/.bashrc
        echo '    echo "$(uname -srm)"' >> rootfs/root/.bashrc
        echo '    echo "================================================"' >> rootfs/root/.bashrc
        echo '}' >> rootfs/root/.bashrc
        echo '' >> rootfs/root/.bashrc
        echo 'zenfetch' >> rootfs/root/.bashrc
        echo 'echo "Type \"zenfetch\" to show this info again"' >> rootfs/root/.bashrc
        echo 'echo "Available tools: bash, busybox, etc."' >> rootfs/root/.bashrc
        
        mkdir -p rootfs/home/wildan
        cp rootfs/root/.bashrc rootfs/home/wildan/

    - name: Create sample programs
      run: |
        echo "Creating sample programs"
        mkdir -p rootfs/home/wildan/zen-hello
        echo '#!/bin/sh' > rootfs/home/wildan/zen-hello/hello
        echo 'echo "Welcome to Zen Unix!"' >> rootfs/home/wildan/zen-hello/hello
        echo 'echo "ARM64 Linux by Wildan Hermawan"' >> rootfs/home/wildan/zen-hello/hello
        echo 'echo "GitHub: https://github.com/sfiraz"' >> rootfs/home/wildan/zen-hello/hello
        echo 'echo "Architecture: aarch64"' >> rootfs/home/wildan/zen-hello/hello
        chmod +x rootfs/home/wildan/zen-hello/hello

    - name: Create device nodes
      run: |
        echo "Creating device nodes"
        sudo mknod rootfs/dev/console c 5 1
        sudo mknod rootfs/dev/null c 1 3
        sudo mknod rootfs/dev/zero c 1 5
        sudo mknod rootfs/dev/random c 1 8
        sudo mknod rootfs/dev/urandom c 1 9

    - name: Create bootable image
      run: |
        echo "Creating bootable image"
        dd if=/dev/zero of=zen-unix.img bs=1M count=256
        mkfs.ext4 -F zen-unix.img
        mkdir -p mnt
        sudo mount -o loop zen-unix.img mnt
        sudo cp -r rootfs/* mnt/
        sudo umount mnt
        
        cp linux-6.6.9/arch/arm64/boot/Image zen-kernel

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zen-unix-complete
        path: |
          zen-unix.img
          zen-kernel
        retention-days: 7

    - name: Show build summary
      run: |
        echo "ZEN UNIX BUILD COMPLETED SUCCESSFULLY"
        echo ""
        echo "FINAL ARTIFACTS:"
        echo "  zen-unix.img (256MB RootFS)"
        echo "  zen-kernel (ARM64 Kernel)"
        echo ""
        echo "INCLUDED COMPONENTS:"
        echo "  Core: Linux Kernel 6.6.9, musl libc, BusyBox"
        echo "  Shell: Bash"
        echo "  Tools: Basic Unix utilities"
        echo "  Custom: Zen Unix branding by Wildan Hermawan"
        echo ""
        echo "BUILD INFO:"
        ls -lh zen-unix.img
        ls -lh zen-kernel
        echo ""
        echo "QUICK START:"
        echo "  qemu-system-aarch64 -M virt -cpu cortex-a53 -smp 4 -m 2G"
        echo "  -kernel zen-kernel -drive file=zen-unix.img,format=raw"
        echo "  -append \"console=ttyAMA0 root=/dev/vda rw init=/init\" -nographic"
        echo ""
        echo "By Wildan Hermawan"
        echo "GitHub: https://github.com/sfiraz"
