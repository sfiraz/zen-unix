name: "[1+2] Build Complete Toolchain + Kernel RootFS + Alpine Packages"

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-complete:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup ARM64 environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu \
          build-essential \
          libncurses-dev \
          bc \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          wget \
          curl \
          xz-utils \
          git \
          make \
          qemu-system-aarch64 \
          qemu-user-static

    - name: Download sources
      run: |
        chmod +x scripts/download-sources.sh
        ./scripts/download-sources.sh

    # ========== PHASE 1: TOOLCHAIN ==========
    - name: Build Binutils
      run: |
        tar xf sources/binutils-2.42.tar.xz
        cd binutils-2.42
        mkdir build && cd build
        ../configure --target=aarch64-linux-gnu --prefix=/usr --disable-werror
        make -j$(nproc)
        make DESTDIR=$PWD/install install
        cd ../..

    - name: Build Linux Kernel Headers
      run: |
        tar xf sources/linux-6.6.9.tar.xz
        cd linux-6.6.9
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- headers_install
        cd ..

    # ========== PHASE 2: KERNEL + ROOTFS ==========
    - name: Build Linux Kernel (FAST Optimized)
      run: |
        cd linux-6.6.9
        
        # Pakai defconfig untuk build cepat
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        # OPTIMASI MAXIMAL untuk build cepat
        ./scripts/config --disable DEBUG_INFO
        ./scripts/config --disable DEBUG_KERNEL
        ./scripts/config --disable DEBUG_FS
        ./scripts/config --disable PROFILING
        ./scripts/config --disable KPROBES
        ./scripts/config --disable KGDB
        ./scripts/config --disable SCHED_DEBUG
        ./scripts/config --disable FTRACE
        ./scripts/config --disable DYNAMIC_DEBUG
        ./scripts/config --disable MODULES
        ./scripts/config --disable IKCONFIG
        ./scripts/config --disable AUDIT
        ./scripts/config --disable SECURITY
        ./scripts/config --disable NETWORK_FILESYSTEMS
        ./scripts/config --disable WIRELESS
        ./scripts/config --disable BLUETOOTH
        ./scripts/config --disable DRM
        ./scripts/config --disable SOUND
        ./scripts/config --disable HID
        ./scripts/config --disable USB
        ./scripts/config --disable PCI
        
        # Enable yang penting saja
        ./scripts/config --enable DEVTMPFS
        ./scripts/config --enable DEVTMPFS_MOUNT
        ./scripts/config --enable TTY
        ./scripts/config --enable SERIAL_AMBA_PL011
        ./scripts/config --enable SERIAL_AMBA_PL011_CONSOLE
        
        # Build dengan optimasi speed
        echo "üöÄ Building kernel with MAX optimization..."
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        time make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
        cd ..

    - name: Build musl libc
      run: |
        tar xf sources/musl-1.2.4.tar.gz
        cd musl-1.2.4
        ./configure --prefix=/usr --target=aarch64-linux-gnu
        make -j$(nproc)
        make DESTDIR=$PWD/install install
        cd ..

    - name: Build BusyBox (Fixed - No Interactive)
      run: |
        tar xf sources/busybox-1.36.1.tar.bz2
        cd busybox-1.36.1
        
        # Pakai defconfig
        make CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        # FIX: Gunakan sed untuk modifikasi config
        sed -i 's/CONFIG_STATIC=.*/CONFIG_STATIC=y/' .config
        sed -i 's/CONFIG_FEATURE_IPV6=.*/# CONFIG_FEATURE_IPV6 is not set/' .config
        sed -i 's/CONFIG_TC=.*/# CONFIG_TC is not set/' .config
        sed -i 's/CONFIG_IP=.*/# CONFIG_IP is not set/' .config
        sed -i 's/CONFIG_NETWORKING=.*/# CONFIG_NETWORKING is not set/' .config
        
        # FIX: Gunakan oldconfig dengan input automatic
        yes "" | make CROSS_COMPILE=aarch64-linux-gnu- oldconfig
        
        # Build static
        echo "üî® Building BusyBox static..."
        time make CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
        cd ..

    - name: Create minimal rootfs
      run: |
        mkdir -p rootfs/{bin,dev,etc,proc,sys,usr/bin,usr/lib,usr/local,var/cache/apk,tmp,home,wildan,root,.config,sbin,lib}
        cp busybox-1.36.1/busybox rootfs/bin/
        cp -r musl-1.2.4/install/usr/lib/* rootfs/usr/lib/
        
        # Pastikan busybox executable
        chmod +x rootfs/bin/busybox
        
        # Create busybox symlinks
        cd rootfs/bin
        for app in $(./busybox --list); do
          ln -s busybox $app 2>/dev/null || true
        done
        cd ../..

    - name: Setup Alpine APK package manager
      run: |
        # Download Alpine APK tools static
        wget http://dl-cdn.alpinelinux.org/alpine/v3.19/main/aarch64/apk-tools-static-2.14.0-r2.apk
        tar -xzf apk-tools-static-2.14.0-r2.apk
        cp sbin/apk.static rootfs/sbin/
        
        # Create APK directories
        mkdir -p rootfs/etc/apk
        mkdir -p rootfs/var/cache/apk
        mkdir -p rootfs/etc/apk/keys
        
        # Setup APK repositories
        echo "http://dl-cdn.alpinelinux.org/alpine/v3.19/main" > rootfs/etc/apk/repositories
        echo "http://dl-cdn.alpinelinux.org/alpine/v3.19/community" >> rootfs/etc/apk/repositories
        
        # Download Alpine keys
        wget http://dl-cdn.alpinelinux.org/alpine/v3.19/main/aarch64/alpine-keys-2.4-r1.apk
        tar -xzf alpine-keys-2.4-r1.apk
        cp -r etc/apk/keys/* rootfs/etc/apk/keys/

    - name: Install Alpine packages using QEMU
      run: |
        # Copy QEMU static binary for chroot
        cp /usr/bin/qemu-aarch64-static rootfs/usr/bin/
        chmod +x rootfs/usr/bin/qemu-aarch64-static
        
        # Setup basic files for Alpine
        echo "nameserver 8.8.8.8" > rootfs/etc/resolv.conf
        echo "zen-unix" > rootfs/etc/hostname
        
        # Chroot and install packages
        sudo chroot rootfs /sbin/apk.static update
        sudo chroot rootfs /sbin/apk.static add --no-cache alpine-base
        sudo chroot rootfs /sbin/apk.static add --no-cache \
          bash curl wget nano htop neofetch git openssh tmux tree bat ripgrep fd fzf jq \
          figlet lolcat cmatrix go build-base cmake pkgconfig util-linux e2fsprogs kbd kmod \
          iproute2 iputils dhcpcd openssh-server
        
        # Remove QEMU binary after use
        rm rootfs/usr/bin/qemu-aarch64-static

    - name: Create custom init script
      run: |
        echo '#!/bin/bash' > rootfs/init
        echo '# Zen Unix Init Script - by Wildan Hermawan' >> rootfs/init
        echo '' >> rootfs/init
        echo '# Mount filesystems' >> rootfs/init
        echo 'mount -t proc none /proc' >> rootfs/init
        echo 'mount -t sysfs none /sys' >> rootfs/init
        echo 'mount -t devtmpfs none /dev' >> rootfs/init
        echo '' >> rootfs/init
        echo '# Create device nodes if needed' >> rootfs/init
        echo 'mknod /dev/console c 5 1 2>/dev/null || true' >> rootfs/init
        echo 'mknod /dev/null c 1 3 2>/dev/null || true' >> rootfs/init
        echo '' >> rootfs/init
        echo '# Setup network' >> rootfs/init
        echo 'mkdir -p /var/run/dhcpcd' >> rootfs/init
        echo 'dhcpcd lo &' >> rootfs/init
        echo '' >> rootfs/init
        echo '# Display welcome message' >> rootfs/init
        echo 'clear' >> rootfs/init
        echo 'echo "================================================"' >> rootfs/init
        echo 'echo "    ___    _   _   ___   _   _   ___"' >> rootfs/init
        echo 'echo "   |__ \\  | \\ | | |__ \\ | \\ | | / _ \\"' >> rootfs/init
        echo 'echo "      ) | |  \\| |    ) ||  \\| || | | |"' >> rootfs/init
        echo 'echo "     / /  | . ` |   / / | . ` || | | |"' >> rootfs/init
        echo 'echo "    / /_  | |\\  |  / /_ | |\\  || |_| |"' >> rootfs/init
        echo 'echo "   |____| |_| \\_| |____||_| \\_| \\___/"' >> rootfs/init
        echo 'echo "================================================"' >> rootfs/init
        echo 'echo "üêß  ARM64 Linux Distro by Wildan Hermawan"' >> rootfs/init
        echo 'echo "üì±  GitHub: https://github.com/sfiraz"' >> rootfs/init
        echo 'echo "üöÄ  Kernel: $(uname -r)"' >> rootfs/init
        echo 'echo "üíª  Alpine Linux with APK package manager"' >> rootfs/init
        echo 'echo "================================================"' >> rootfs/init
        echo 'echo ""' >> rootfs/init
        echo '' >> rootfs/init
        echo '# Start SSH server if available' >> rootfs/init
        echo 'if [ -f /usr/sbin/sshd ]; then' >> rootfs/init
        echo '    /usr/sbin/sshd &' >> rootfs/init
        echo '    echo "üîê SSH server started on port 22"' >> rootfs/init
        echo 'fi' >> rootfs/init
        echo '' >> rootfs/init
        echo '# Start shell' >> rootfs/init
        echo 'exec /bin/bash' >> rootfs/init
        chmod +x rootfs/init

    - name: Create user profile and customization
      run: |
        # Create .bashrc with customizations
        echo '# Zen Unix Custom Bashrc' > rootfs/root/.bashrc
        echo 'export PS1='"'"'\[\033[1;32m\]\u@zen-unix\[\033[0m\]:\[\033[1;34m\]\w\[\033[0m\]\$ '"'" >> rootfs/root/.bashrc
        echo '' >> rootfs/root/.bashrc
        echo '# Aliases' >> rootfs/root/.bashrc
        echo "alias ls='ls --color=auto'" >> rootfs/root/.bashrc
        echo "alias ll='ls -la'" >> rootfs/root/.bashrc
        echo "alias la='ls -A'" >> rootfs/root/.bashrc
        echo "alias grep='grep --color=auto'" >> rootfs/root/.bashrc
        echo "alias cat='bat'" >> rootfs/root/.bashrc
        echo "alias find='fd'" >> rootfs/root/.bashrc
        echo "alias ..='cd ..'" >> rootfs/root/.bashrc
        echo "alias ...='cd ../..'" >> rootfs/root/.bashrc
        echo '' >> rootfs/root/.bashrc
        echo '# Functions' >> rootfs/root/.bashrc
        echo 'zenfetch() {' >> rootfs/root/.bashrc
        echo '    clear' >> rootfs/root/.bashrc
        echo '    echo "================================================"' >> rootfs/root/.bashrc
        echo '    echo "    ___    _   _   ___   _   _   ___"' >> rootfs/root/.bashrc
        echo '    echo "   |__ \\  | \\ | | |__ \\ | \\ | | / _ \\"' >> rootfs/root/.bashrc
        echo '    echo "      ) | |  \\| |    ) ||  \\| || | | |"' >> rootfs/root/.bashrc
        echo '    echo "     / /  | . ` |   / / | . ` || | | |"' >> rootfs/root/.bashrc
        echo '    echo "    / /_  | |\\  |  / /_ | |\\  || |_| |"' >> rootfs/root/.bashrc
        echo '    echo "   |____| |_| \\_| |____||_| \\_| \\___/"' >> rootfs/root/.bashrc
        echo '    echo "================================================"' >> rootfs/root/.bashrc
        echo '    echo "üêß  ARM64 Linux by Wildan Hermawan"' >> rootfs/root/.bashrc
        echo '    echo "üì±  GitHub: https://github.com/sfiraz"' >> rootfs/root/.bashrc
        echo '    echo "üöÄ  $(uname -srm)"' >> rootfs/root/.bashrc
        echo '    echo "üíª  Alpine Linux $(cat /etc/alpine-release 2>/dev/null || echo '"'"'Musl Linux'"'"')"' >> rootfs/root/.bashrc
        echo '    echo "================================================"' >> rootfs/root/.bashrc
        echo '}' >> rootfs/root/.bashrc
        echo '' >> rootfs/root/.bashrc
        echo '# Welcome message' >> rootfs/root/.bashrc
        echo 'zenfetch' >> rootfs/root/.bashrc
        echo 'echo "Type '"'"'zenfetch'"'"' to show this info again"' >> rootfs/root/.bashrc
        echo 'echo "Available tools: bash, curl, wget, nano, htop, git, tmux, go, etc."' >> rootfs/root/.bashrc

        # Copy .bashrc to home directory
        cp rootfs/root/.bashrc rootfs/home/

    - name: Create Go workspace and setup
      run: |
        # Setup Go environment
        mkdir -p rootfs/home/go/{bin,src,pkg}
        echo '' >> rootfs/root/.bashrc
        echo '# Go environment' >> rootfs/root/.bashrc
        echo 'export GOPATH=/home/go' >> rootfs/root/.bashrc
        echo 'export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin' >> rootfs/root/.bashrc

        # Create sample Go program
        mkdir -p rootfs/home/wildan/hello
        echo 'package main' > rootfs/home/wildan/hello/main.go
        echo '' >> rootfs/home/wildan/hello/main.go
        echo 'import "fmt"' >> rootfs/home/wildan/hello/main.go
        echo '' >> rootfs/home/wildan/hello/main.go
        echo 'func main() {' >> rootfs/home/wildan/hello/main.go
        echo '    fmt.Println("üêß Welcome to Zen Unix!")' >> rootfs/home/wildan/hello/main.go
        echo '    fmt.Println("üì± ARM64 Linux by Wildan Hermawan")' >> rootfs/home/wildan/hello/main.go
        echo '    fmt.Println("üöÄ Powered by Go")' >> rootfs/home/wildan/hello/main.go
        echo '    fmt.Printf("üíª Architecture: %s\n", "aarch64")' >> rootfs/home/wildan/hello/main.go
        echo '}' >> rootfs/home/wildan/hello/main.go

    - name: Create essential device nodes
      run: |
        sudo mknod rootfs/dev/console c 5 1
        sudo mknod rootfs/dev/null c 1 3
        sudo mknod rootfs/dev/zero c 1 5
        sudo mknod rootfs/dev/random c 1 8
        sudo mknod rootfs/dev/urandom c 1 9

    - name: Create bootable image
      run: |
        dd if=/dev/zero of=zen-unix.img bs=1M count=256
        mkfs.ext4 -F zen-unix.img
        mkdir -p mnt
        sudo mount -o loop zen-unix.img mnt
        sudo cp -r rootfs/* mnt/
        sudo umount mnt

    - name: Upload final image
      uses: actions/upload-artifact@v4
      with:
        name: zen-unix-complete
        path: |
          zen-unix.img
          linux-6.6.9/arch/arm64/boot/Image
        retention-days: 7

    - name: Show build success
      run: |
        echo "‚úÖ Build completed successfully!"
        echo "üì¶ Final artifacts: zen-unix.img + Kernel Image"
        echo "üêß Included packages:"
        echo "   - Core: bash, musl, busybox, alpine-base"
        echo "   - Tools: curl, wget, nano, htop, neofetch"
        echo "   - Dev: git, go, build-base, cmake"
        echo "   - CLI UX: tmux, tree, bat, ripgrep, fd, fzf, jq"
        echo "   - Aesthetic: figlet, lolcat, cmatrix"
        echo "   - Network: openssh, iproute2, dhcpcd"
        ls -lh zen-unix.img
        ls -lh linux-6.6.9/arch/arm64/boot/Image
