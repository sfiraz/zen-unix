name: "[1+2] Build Complete Toolchain + Kernel RootFS + Alpine Packages"

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-complete:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup ARM64 environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu \
          build-essential \
          libncurses-dev \
          bc \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          wget \
          curl \
          xz-utils \
          git \
          make \
          qemu-system-aarch64 \
          qemu-user-static

    - name: Download sources
      run: |
        chmod +x scripts/download-sources.sh
        ./scripts/download-sources.sh

    # ========== PHASE 1: TOOLCHAIN ==========
    - name: Build Binutils
      run: |
        tar xf sources/binutils-2.42.tar.xz
        cd binutils-2.42
        mkdir build && cd build
        ../configure --target=aarch64-linux-gnu --prefix=/usr --disable-werror
        make -j$(nproc)
        make DESTDIR=$PWD/install install
        cd ../..

    - name: Build Linux Kernel Headers
      run: |
        tar xf sources/linux-6.6.9.tar.xz
        cd linux-6.6.9
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- headers_install
        cd ..

    # ========== PHASE 2: KERNEL + ROOTFS ==========
    - name: Build Linux Kernel (FAST Optimized)
      run: |
        cd linux-6.6.9
        
        # Pakai defconfig untuk build cepat
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        # OPTIMASI MAXIMAL untuk build cepat
        ./scripts/config --disable DEBUG_INFO
        ./scripts/config --disable DEBUG_KERNEL
        ./scripts/config --disable DEBUG_FS
        ./scripts/config --disable PROFILING
        ./scripts/config --disable KPROBES
        ./scripts/config --disable KGDB
        ./scripts/config --disable SCHED_DEBUG
        ./scripts/config --disable FTRACE
        ./scripts/config --disable DYNAMIC_DEBUG
        ./scripts/config --disable MODULES
        ./scripts/config --disable IKCONFIG
        ./scripts/config --disable AUDIT
        ./scripts/config --disable SECURITY
        ./scripts/config --disable NETWORK_FILESYSTEMS
        ./scripts/config --disable WIRELESS
        ./scripts/config --disable BLUETOOTH
        ./scripts/config --disable DRM
        ./scripts/config --disable SOUND
        ./scripts/config --disable HID
        ./scripts/config --disable USB
        ./scripts/config --disable PCI
        
        # Enable yang penting saja
        ./scripts/config --enable DEVTMPFS
        ./scripts/config --enable DEVTMPFS_MOUNT
        ./scripts/config --enable TTY
        ./scripts/config --enable SERIAL_AMBA_PL011
        ./scripts/config --enable SERIAL_AMBA_PL011_CONSOLE
        
        # Build dengan optimasi speed
        echo "ðŸš€ Building kernel with MAX optimization..."
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        time make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
        cd ..

    - name: Build musl libc
      run: |
        tar xf sources/musl-1.2.4.tar.gz
        cd musl-1.2.4
        ./configure --prefix=/usr --target=aarch64-linux-gnu
        make -j$(nproc)
        make DESTDIR=$PWD/install install
        cd ..

    - name: Build BusyBox (Fixed - No Interactive)
      run: |
        tar xf sources/busybox-1.36.1.tar.bz2
        cd busybox-1.36.1
        
        # Pakai defconfig
        make CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        # FIX: Gunakan sed untuk modifikasi config
        sed -i 's/CONFIG_STATIC=.*/CONFIG_STATIC=y/' .config
        sed -i 's/CONFIG_FEATURE_IPV6=.*/# CONFIG_FEATURE_IPV6 is not set/' .config
        sed -i 's/CONFIG_TC=.*/# CONFIG_TC is not set/' .config
        sed -i 's/CONFIG_IP=.*/# CONFIG_IP is not set/' .config
        sed -i 's/CONFIG_NETWORKING=.*/# CONFIG_NETWORKING is not set/' .config
        
        # FIX: Gunakan oldconfig dengan input automatic
        yes "" | make CROSS_COMPILE=aarch64-linux-gnu- oldconfig
        
        # Build static
        echo "ðŸ”¨ Building BusyBox static..."
        time make CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
        cd ..

    - name: Create minimal rootfs
      run: |
        mkdir -p rootfs/{bin,dev,etc,proc,sys,usr/bin,usr/lib,usr/local,var/cache/apk,tmp,home,wildan,root,.config}
        cp busybox-1.36.1/busybox rootfs/bin/
        cp -r musl-1.2.4/install/usr/lib/* rootfs/usr/lib/
        
        # Pastikan busybox executable
        chmod +x rootfs/bin/busybox
        
        # Create busybox symlinks
        cd rootfs/bin
        for app in $(./busybox --list); do
          ln -s busybox $app 2>/dev/null || true
        done
        cd ../..

    - name: Setup Alpine APK package manager
      run: |
        # Download Alpine APK tools static
        wget http://dl-cdn.alpinelinux.org/alpine/v3.19/main/aarch64/apk-tools-static-2.14.0-r2.apk
        tar -xzf apk-tools-static-2.14.0-r2.apk
        cp sbin/apk.static rootfs/sbin/
        
        # Create APK directories
        mkdir -p rootfs/etc/apk
        mkdir -p rootfs/var/cache/apk
        mkdir -p rootfs/etc/apk/keys
        
        # Setup APK repositories
        cat > rootfs/etc/apk/repositories << EOF
        http://dl-cdn.alpinelinux.org/alpine/v3.19/main
        http://dl-cdn.alpinelinux.org/alpine/v3.19/community
        EOF
        
        # Download and setup Alpine keys
        wget -O rootfs/etc/apk/keys/alpine-devel@lists.alpinelinux.org-6165ee59.rsa.pub \
          http://dl-cdn.alpinelinux.org/alpine/v3.19/main/aarch64/alpine-keys-2.4-r1.apk
        tar -xzf alpine-keys-2.4-r1.apk
        cp etc/apk/keys/* rootfs/etc/apk/keys/

    - name: Install Alpine packages using QEMU
      run: |
        # Copy QEMU static binary for chroot
        cp /usr/bin/qemu-aarch64-static rootfs/usr/bin/
        
        # Chroot and install packages
        sudo chroot rootfs /sbin/apk.static update
        sudo chroot rootfs /sbin/apk.static add --no-cache \
          bash curl wget nano htop neofetch git openssh tmux tree bat ripgrep fd fzf jq \
          figlet lolcat cmatrix go build-base cmake pkgconfig util-linux e2fsprogs kbd kmod \
          iproute2 iputils dhcpcd openssh-server
        
        # Remove QEMU binary after use
        rm rootfs/usr/bin/qemu-aarch64-static

    - name: Create custom init script with Alpine
      run: |
        cat > rootfs/init << 'EOF'
#!/bin/bash
# Zen Unix Init Script - by Wildan Hermawan

# Mount filesystems
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev

# Create device nodes if needed
mknod /dev/console c 5 1 2>/dev/null || true
mknod /dev/null c 1 3 2>/dev/null || true

# Setup network
mkdir -p /var/run/dhcpcd
dhcpcd lo &

# Display welcome message
clear
echo "================================================"
figlet "Zen Unix" | lolcat
echo "================================================"
echo "ðŸ§  ARM64 Linux Distro by Wildan Hermawan"
echo "ðŸ“±  GitHub: https://github.com/sfiraz"
echo "ðŸš€  Kernel: $(uname -r)"
echo "ðŸ’»  $(neofetch --stdout | head -1)"
echo "================================================"
echo ""

# Start SSH server if available
if [ -f /usr/sbin/sshd ]; then
    /usr/sbin/sshd &
    echo "ðŸ” SSH server started on port 22"
fi

# Start shell
exec /bin/bash
EOF
        chmod +x rootfs/init

    - name: Create user profile and customization
      run: |
        # Create .bashrc with customizations
        cat > rootfs/root/.bashrc << 'EOF'
# Zen Unix Custom Bashrc
export PS1='\[\033[1;32m\]\u@zen-unix\[\033[0m\]:\[\033[1;34m\]\w\[\033[0m\]\$ '

# Aliases
alias ls='ls --color=auto'
alias ll='ls -la'
alias la='ls -A'
alias grep='grep --color=auto'
alias cat='bat'
alias find='fd'
alias ..='cd ..'
alias ...='cd ../..'

# Functions
zenfetch() {
    clear
    echo "================================================"
    figlet "Zen Unix" | lolcat
    echo "================================================"
    echo "ðŸ§  ARM64 Linux by Wildan Hermawan"
    echo "ðŸ“±  GitHub: https://github.com/sfiraz"
    echo "ðŸš€  $(uname -srm)"
    echo "ðŸ’»  $(cat /etc/alpine-release 2>/dev/null || echo 'Musl Linux')"
    echo "================================================"
}

# Welcome message
zenfetch
echo "Type 'zenfetch' to show this info again"
echo "Available tools: bash, curl, wget, nano, htop, git, tmux, go, etc."
EOF

        # Copy .bashrc to home directory
        cp rootfs/root/.bashrc rootfs/home/

    - name: Create Go workspace and setup
      run: |
        # Setup Go environment
        mkdir -p rootfs/home/go/{bin,src,pkg}
        cat >> rootfs/root/.bashrc << 'EOF'

# Go environment
export GOPATH=/home/go
export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
EOF

        # Create sample Go program
        mkdir -p rootfs/home/wildan/hello
        cat > rootfs/home/wildan/hello/main.go << 'EOF'
package main

import "fmt"

func main() {
    fmt.Println("ðŸ§ Welcome to Zen Unix!")
    fmt.Println("ðŸ“± ARM64 Linux by Wildan Hermawan")
    fmt.Println("ðŸš€ Powered by Go")
    fmt.Printf("ðŸ’» Architecture: %s\n", "aarch64")
}
EOF

    - name: Create essential device nodes
      run: |
        sudo mknod rootfs/dev/console c 5 1
        sudo mknod rootfs/dev/null c 1 3
        sudo mknod rootfs/dev/zero c 1 5
        sudo mknod rootfs/dev/random c 1 8
        sudo mknod rootfs/dev/urandom c 1 9

    - name: Create bootable image
      run: |
        dd if=/dev/zero of=zen-unix.img bs=1M count=256
        mkfs.ext4 -F zen-unix.img
        mkdir -p mnt
        sudo mount -o loop zen-unix.img mnt
        sudo cp -r rootfs/* mnt/
        sudo umount mnt

    - name: Upload final image
      uses: actions/upload-artifact@v4
      with:
        name: zen-unix-complete
        path: |
          zen-unix.img
          linux-6.6.9/arch/arm64/boot/Image
        retention-days: 7

    - name: Show build success
      run: |
        echo "âœ… Build completed successfully!"
        echo "ðŸ“¦ Final artifacts: zen-unix.img + Kernel Image"
        echo "ðŸ§ Included packages:"
        echo "   - Core: bash, musl, busybox, apk"
        echo "   - Tools: curl, wget, nano, htop, neofetch"
        echo "   - Dev: git, go, build-base, cmake"
        echo "   - CLI UX: tmux, tree, bat, ripgrep, fd, fzf, jq"
        echo "   - Aesthetic: figlet, lolcat, cmatrix"
        echo "   - Network: openssh, iproute2, dhcpcd"
        ls -lh zen-unix.img
        ls -lh linux-6.6.9/arch/arm64/boot/Image
