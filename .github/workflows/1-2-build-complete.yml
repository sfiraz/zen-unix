name: "Zen Unix Complete Build"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Zen Unix Version'
        required: true
        default: '1.0.0'
  push:
    branches: [main]

env:
  ZEN_VERSION: '1.0.0'
  BUILD_ARCH: 'aarch64'
  KERNEL_VERSION: '6.6.9'
  MUSL_VERSION: '1.2.4'
  BUSYBOX_VERSION: '1.36.1'
  BINUTILS_VERSION: '2.42'

jobs:
  build-complete-system:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu \
          build-essential \
          libncurses-dev \
          bc \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          wget \
          curl \
          xz-utils \
          git \
          make \
          cmake \
          qemu-system-aarch64 \
          qemu-user-static

    - name: Create directory structure
      run: |
        mkdir -p sources build rootfs output
        mkdir -p rootfs/{bin,dev,etc,proc,sys,usr/{bin,lib,local,share,include},var/{cache,log,lib},tmp,home,root,boot,mnt,opt,run}
        mkdir -p rootfs/usr/local/bin

    - name: Download source packages
      run: |
        cd sources
        echo "Downloading source packages"
        
        wget --timeout=60 --tries=3 https://mirror.koddos.net/gnu/binutils/binutils-2.42.tar.xz || \
        wget --timeout=60 --tries=3 https://ftp.gnu.org/gnu/binutils/binutils-2.42.tar.xz
        
        wget --timeout=60 --tries=3 https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.9.tar.xz
        
        wget --timeout=60 --tries=3 https://musl.libc.org/releases/musl-1.2.4.tar.gz
        
        wget --timeout=60 --tries=3 https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        
        cd ..

    - name: Build Binutils
      run: |
        echo "Building Binutils"
        tar xf sources/binutils-2.42.tar.xz
        cd binutils-2.42
        mkdir build && cd build
        ../configure --target=aarch64-linux-gnu --prefix=/usr --disable-werror
        make -j$(nproc)
        make DESTDIR=$PWD/install install
        cd ../..

    - name: Build Linux Kernel Headers
      run: |
        echo "Building Kernel Headers"
        tar xf sources/linux-6.6.9.tar.xz
        cd linux-6.6.9
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- headers_install
        cd ..

    - name: Build Linux Kernel
      run: |
        echo "Building Linux Kernel"
        cd linux-6.6.9
        
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        ./scripts/config --disable DEBUG_INFO
        ./scripts/config --disable DEBUG_KERNEL
        ./scripts/config --disable DEBUG_FS
        ./scripts/config --disable PROFILING
        ./scripts/config --disable KPROBES
        ./scripts/config --disable KGDB
        ./scripts/config --disable SCHED_DEBUG
        ./scripts/config --disable FTRACE
        ./scripts/config --disable DYNAMIC_DEBUG
        ./scripts/config --disable MODULES
        
        ./scripts/config --enable DEVTMPFS
        ./scripts/config --enable DEVTMPFS_MOUNT
        ./scripts/config --enable TTY
        ./scripts/config --enable SERIAL_AMBA_PL011
        ./scripts/config --enable SERIAL_AMBA_PL011_CONSOLE
        
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        time make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
        cd ..

    - name: Build musl libc
      run: |
        echo "Building musl libc"
        tar xf sources/musl-1.2.4.tar.gz
        cd musl-1.2.4
        ./configure --prefix=/usr --target=aarch64-linux-gnu
        make -j$(nproc)
        make DESTDIR=$PWD/install install
        cp -r install/usr/* ../rootfs/usr/
        cd ..

    - name: Build BusyBox Fixed
      run: |
        echo "Building BusyBox with fixes"
        tar xf sources/busybox-1.36.1.tar.bz2
        cd busybox-1.36.1
        
        make CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        sed -i 's/CONFIG_STATIC=.*/CONFIG_STATIC=y/' .config
        sed -i 's/CONFIG_FEATURE_IPV6=.*/# CONFIG_FEATURE_IPV6 is not set/' .config
        
        sed -i 's/CONFIG_TC=.*/# CONFIG_TC is not set/' .config
        sed -i 's/CONFIG_WATCHDOG=.*/# CONFIG_WATCHDOG is not set/' .config
        sed -i 's/CONFIG_SLATTACH=.*/# CONFIG_SLATTACH is not set/' .config
        sed -i 's/CONFIG_UDHCPD=.*/# CONFIG_UDHCPD is not set/' .config
        sed -i 's/CONFIG_UDHCPC=.*/# CONFIG_UDHCPC is not set/' .config
        sed -i 's/CONFIG_FEATURE_UDHCPD_WRITE_LEASES_EARLY=.*/# CONFIG_FEATURE_UDHCPD_WRITE_LEASES_EARLY is not set/' .config
        sed -i 's/CONFIG_FEATURE_UDHCPD_BASE_IP_ON_MAC=.*/# CONFIG_FEATURE_UDHCPD_BASE_IP_ON_MAC is not set/' .config
        
        yes "n" | make CROSS_COMPILE=aarch64-linux-gnu- oldconfig
        time make CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
        
        cp busybox ../rootfs/bin/
        chmod +x ../rootfs/bin/busybox
        cd ..

    - name: Setup BusyBox symlinks
      run: |
        echo "Creating BusyBox symlinks"
        cd rootfs/bin
        for app in $(./busybox --list); do
          if [ ! -e "$app" ] && [ "$app" != "busybox" ]; then
            ln -s busybox "$app"
          fi
        done
        cd ../..

    - name: Download and install static binaries
      run: |
        echo "Downloading static binaries for essential tools"
        
        # Download static binaries (jika tersedia)
        mkdir -p rootfs/usr/local/bin
        
        # Download static bash
        wget -O rootfs/bin/bash https://github.com/robxu9/bash-static/releases/download/5.1.008-1/bash-linux-aarch64 || echo "Bash download failed, using busybox ash"
        
        # Download static curl (jika tersedia)
        wget -O rootfs/usr/local/bin/curl https://github.com/moparisthebest/static-curl/releases/download/v7.88.1/curl-aarch64 || echo "Curl download failed"
        
        # Download static wget (jika tersedia)  
        wget -O rootfs/usr/local/bin/wget https://github.com/moparisthebest/static-curl/releases/download/v7.88.1/wget-aarch64 || echo "Wget download failed"
        
        # Make binaries executable
        chmod +x rootfs/bin/bash 2>/dev/null || true
        chmod +x rootfs/usr/local/bin/curl 2>/dev/null || true
        chmod +x rootfs/usr/local/bin/wget 2>/dev/null || true

    - name: Build additional tools from source
      run: |
        echo "Building additional tools from source"
        
        # Build nano from source
        wget https://www.nano-editor.org/dist/v7/nano-7.2.tar.gz
        tar xzf nano-7.2.tar.gz
        cd nano-7.2
        ./configure --host=aarch64-linux-gnu --enable-static --disable-nls --disable-utf8
        make -j$(nproc)
        cp src/nano ../rootfs/usr/local/bin/
        cd ..
        
        # Build htop from source
        wget https://github.com/htop-dev/htop/archive/refs/tags/3.2.2.tar.gz
        tar xzf 3.2.2.tar.gz
        cd htop-3.2.2
        ./autogen.sh
        ./configure --host=aarch64-linux-gnu --enable-static --disable-nls
        make -j$(nproc)
        cp htop ../rootfs/usr/local/bin/
        cd ..
        
        # Build tree from source
        wget http://mama.indstate.edu/users/ice/tree/src/tree-2.1.1.tgz
        tar xzf tree-2.1.1.tgz
        cd tree-2.1.1
        make CC=aarch64-linux-gnu-gcc static
        cp tree ../rootfs/usr/local/bin/
        cd ..

    - name: Create essential system files
      run: |
        echo "Creating essential system files"
        
        # Create passwd file
        echo "root:x:0:0:root:/root:/bin/bash" > rootfs/etc/passwd
        echo "wildan:x:1000:1000:Wildan Hermawan:/home/wildan:/bin/bash" >> rootfs/etc/passwd
        
        # Create group file
        echo "root:x:0:" > rootfs/etc/group
        echo "wildan:x:1000:" >> rootfs/etc/group
        
        # Create hosts file
        echo "127.0.0.1 localhost" > rootfs/etc/hosts
        echo "127.0.1.1 zen-unix" >> rootfs/etc/hosts
        
        # Create hostname
        echo "zen-unix" > rootfs/etc/hostname
        
        # Create fstab
        echo "/dev/root / ext4 defaults 0 1" > rootfs/etc/fstab
        echo "proc /proc proc defaults 0 0" >> rootfs/etc/fstab
        echo "tmpfs /tmp tmpfs defaults 0 0" >> rootfs/etc/fstab

    - name: Create init script
      run: |
        echo "Creating init script"
        
        echo '#!/bin/sh' > rootfs/init
        echo '' >> rootfs/init
        echo 'export PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin' >> rootfs/init
        echo '' >> rootfs/init
        echo 'mount -t proc none /proc' >> rootfs/init
        echo 'mount -t sysfs none /sys' >> rootfs/init
        echo 'mount -t devtmpfs none /dev' >> rootfs/init
        echo 'mount -t tmpfs none /tmp' >> rootfs/init
        echo '' >> rootfs/init
        echo 'mknod /dev/console c 5 1 2>/dev/null || true' >> rootfs/init
        echo 'mknod /dev/null c 1 3 2>/dev/null || true' >> rootfs/init
        echo 'mknod /dev/zero c 1 5 2>/dev/null || true' >> rootfs/init
        echo 'mknod /dev/random c 1 8 2>/dev/null || true' >> rootfs/init
        echo '' >> rootfs/init
        echo 'mkdir -p /var/run' >> rootfs/init
        echo 'ip link set lo up' >> rootfs/init
        echo '' >> rootfs/init
        echo 'clear' >> rootfs/init
        echo 'echo "================================================"' >> rootfs/init
        echo 'echo "    ___    _   _   ___   _   _   ___"' >> rootfs/init
        echo 'echo "   |__ \\  | \\ | | |__ \\ | \\ | | / _ \\"' >> rootfs/init
        echo 'echo "      ) | |  \\| |    ) ||  \\| || | | |"' >> rootfs/init
        echo 'echo "     / /  | . \` |   / / | . \` || | | |"' >> rootfs/init
        echo 'echo "    / /_  | |\\  |  / /_ | |\\  || |_| |"' >> rootfs/init
        echo 'echo "   |____| |_| \\_| |____||_| \\_| \\___/"' >> rootfs/init
        echo 'echo "================================================"' >> rootfs/init
        echo 'echo "ARM64 Linux Distro by Wildan Hermawan"' >> rootfs/init
        echo 'echo "GitHub: https://github.com/sfiraz"' >> rootfs/init
        echo 'echo "Version: 1.0.0"' >> rootfs/init
        echo 'echo "Kernel: $(uname -r)"' >> rootfs/init
        echo 'echo "Architecture: aarch64"' >> rootfs/init
        echo 'echo "================================================"' >> rootfs/init
        echo 'echo ""' >> rootfs/init
        echo '' >> rootfs/init
        echo 'export PS1="[\\u@zen-unix:\\w]# "' >> rootfs/init
        echo 'exec /bin/sh' >> rootfs/init
        
        chmod +x rootfs/init

    - name: Create user environment
      run: |
        echo "Creating user environment"
        
        echo '# Zen Unix Shell Configuration' > rootfs/root/.profile
        echo '' >> rootfs/root/.profile
        echo 'export PS1="[\\u@zen-unix:\\w]# "' >> rootfs/root/.profile
        echo 'export TERM=linux' >> rootfs/root/.profile
        echo '' >> rootfs/root/.profile
        echo 'alias ls="ls --color=auto"' >> rootfs/root/.profile
        echo 'alias ll="ls -la"' >> rootfs/root/.profile
        echo 'alias la="ls -A"' >> rootfs/root/.profile
        echo 'alias grep="grep --color=auto"' >> rootfs/root/.profile
        echo 'alias ..="cd .."' >> rootfs/root/.profile
        echo 'alias ...="cd ../.."' >> rootfs/root/.profile
        echo '' >> rootfs/root/.profile
        echo 'zenfetch() {' >> rootfs/root/.profile
        echo '    clear' >> rootfs/root/.profile
        echo '    echo "================================================"' >> rootfs/root/.profile
        echo '    echo "    ___    _   _   ___   _   _   ___"' >> rootfs/root/.profile
        echo '    echo "   |__ \\  | \\ | | |__ \\ | \\ | | / _ \\"' >> rootfs/root/.profile
        echo '    echo "      ) | |  \\| |    ) ||  \\| || | | |"' >> rootfs/root/.profile
        echo '    echo "     / /  | . \` |   / / | . \` || | | |"' >> rootfs/root/.profile
        echo '    echo "    / /_  | |\\  |  / /_ | |\\  || |_| |"' >> rootfs/root/.profile
        echo '    echo "   |____| |_| \\_| |____||_| \\_| \\___/"' >> rootfs/root/.profile
        echo '    echo "================================================"' >> rootfs/root/.profile
        echo '    echo "ARM64 Linux by Wildan Hermawan"' >> rootfs/root/.profile
        echo '    echo "GitHub: https://github.com/sfiraz"' >> rootfs/root/.profile
        echo '    echo "$(uname -srm)"' >> rootfs/root/.profile
        echo '    echo "================================================"' >> rootfs/root/.profile
        echo '}' >> rootfs/root/.profile
        echo '' >> rootfs/root/.profile
        echo 'zenfetch' >> rootfs/root/.profile
        echo 'echo "Type \"zenfetch\" to show this info again"' >> rootfs/root/.profile
        echo 'echo "Available tools: busybox, nano, htop, tree"' >> rootfs/root/.profile
        
        mkdir -p rootfs/home/wildan
        cp rootfs/root/.profile rootfs/home/wildan/

    - name: Create sample programs
      run: |
        echo "Creating sample programs"
        
        # Create welcome script
        echo '#!/bin/sh' > rootfs/usr/local/bin/zen-welcome
        echo 'echo "================================================"' >> rootfs/usr/local/bin/zen-welcome
        echo 'echo "Welcome to Zen Unix"' >> rootfs/usr/local/bin/zen-welcome
        echo 'echo "ARM64 Linux Distribution"' >> rootfs/usr/local/bin/zen-welcome
        echo 'echo "By Wildan Hermawan"' >> rootfs/usr/local/bin/zen-welcome
        echo 'echo "GitHub: https://github.com/sfiraz"' >> rootfs/usr/local/bin/zen-welcome
        echo 'echo "================================================"' >> rootfs/usr/local/bin/zen-welcome
        chmod +x rootfs/usr/local/bin/zen-welcome
        
        # Create system info script
        echo '#!/bin/sh' > rootfs/usr/local/bin/zen-info
        echo 'echo "System Information:"' >> rootfs/usr/local/bin/zen-info
        echo 'echo "  Hostname: $(hostname)"' >> rootfs/usr/local/bin/zen-info
        echo 'echo "  Kernel: $(uname -r)"' >> rootfs/usr/local/bin/zen-info
        echo 'echo "  Architecture: $(uname -m)"' >> rootfs/usr/local/bin/zen-info
        echo 'echo "  CPU: $(grep -c ^processor /proc/cpuinfo) cores"' >> rootfs/usr/local/bin/zen-info
        echo 'echo "  Memory: $(free -h | grep Mem: | awk "{print $2}") total"' >> rootfs/usr/local/bin/zen-info
        chmod +x rootfs/usr/local/bin/zen-info

    - name: Create device nodes
      run: |
        echo "Creating device nodes"
        sudo mknod rootfs/dev/console c 5 1
        sudo mknod rootfs/dev/null c 1 3
        sudo mknod rootfs/dev/zero c 1 5
        sudo mknod rootfs/dev/random c 1 8
        sudo mknod rootfs/dev/urandom c 1 9

    - name: Create bootable image
      run: |
        echo "Creating bootable image"
        dd if=/dev/zero of=zen-unix.img bs=1M count=128
        mkfs.ext4 -F zen-unix.img
        mkdir -p mnt
        sudo mount -o loop zen-unix.img mnt
        sudo cp -r rootfs/* mnt/
        sudo umount mnt
        
        cp linux-6.6.9/arch/arm64/boot/Image zen-kernel
        echo "Bootable image created"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zen-unix-complete
        path: |
          zen-unix.img
          zen-kernel
        retention-days: 7

    - name: Show build summary
      run: |
        echo "ZEN UNIX BUILD COMPLETED SUCCESSFULLY"
        echo ""
        echo "FINAL ARTIFACTS:"
        echo "  zen-unix.img (128MB RootFS)"
        echo "  zen-kernel (ARM64 Kernel)"
        echo ""
        echo "INCLUDED COMPONENTS:"
        echo "  Core: Linux Kernel 6.6.9, musl libc, BusyBox"
        echo "  Shell: BusyBox ash with custom profile"
        echo "  Tools: nano, htop, tree (statically compiled)"
        echo "  Custom: Zen Unix branding by Wildan Hermawan"
        echo "  Scripts: zen-welcome, zen-info"
        echo ""
        echo "BUILD INFO:"
        ls -lh zen-unix.img
        ls -lh zen-kernel
        echo ""
        echo "QUICK START:"
        echo "  qemu-system-aarch64 -M virt -cpu cortex-a53 -smp 4 -m 2G"
        echo "  -kernel zen-kernel -drive file=zen-unix.img,format=raw"
        echo "  -append \"console=ttyAMA0 root=/dev/vda rw init=/init\" -nographic"
        echo ""
        echo "FEATURES:"
        echo "  - Bootable ARM64 system"
        echo "  - Custom init script with branding"
        echo "  - Essential command line tools"
        echo "  - Static compilation (no dependencies)"
        echo "  - Minimal and fast"
        echo ""
        echo "By Wildan Hermawan"
        echo "GitHub: https://github.com/sfiraz"
