name: "[1] Build ARM64 Toolchain"

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-toolchain:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup ARM64 environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu \
          build-essential \
          libncurses-dev \
          bc \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          wget \
          curl \
          xz-utils

    - name: Download sources
      run: |
        chmod +x scripts/download-sources.sh
        ./scripts/download-sources.sh

    - name: Build Binutils
      run: |
        tar xf sources/binutils-2.42.tar.xz
        cd binutils-2.42
        mkdir build && cd build
        ../configure --target=aarch64-linux-gnu --prefix=/usr --disable-werror
        make -j$(nproc)
        make DESTDIR=$PWD/install install
        cd ../..

    - name: Build Linux Kernel Headers
      run: |
        tar xf sources/linux-6.6.9.tar.xz
        cd linux-6.6.9
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- headers_install
        cd ..

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: toolchain-arm64
        path: |
          binutils-2.42/build/install/
          linux-6.6.9/usr/include/
          sources/
